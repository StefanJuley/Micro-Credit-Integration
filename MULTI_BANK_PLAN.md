# План: Мульти-банковская интеграция

## Текущее состояние

- Работает интеграция с Microinvest
- Сервер: https://credit.pandashop.md (VPS 195.201.19.112)
- 1 заказ = 1 банк = 1 заявка

## Цель

Поддержка нескольких банков (Microinvest, Easy Credit, Iute Credit, Maib) с возможностью переотправки заявки в другой банк при отказе.

## Архитектура

### Новая таблица `CreditApplication`

```prisma
model CreditApplication {
  id            String   @id @default(cuid())
  orderId       Int
  orderNumber   String
  bank          String   // microinvest, easy-credit, iute-credit, maib
  applicationId String?  // ID от банка (после отправки)
  status        String   // pending, processing, approved, refused, cancelled
  bankResponse  Json?    // полный ответ от банка
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  @@index([orderId])
  @@index([bank, status])
}
```

### Логика работы

1. Менеджер выбирает банк в виджете
2. Создаётся запись в `credit_applications` (status: pending)
3. Отправляем заявку в выбранный банк
4. Обновляем `applicationId` и `status` по ответу банка
5. При отказе:
   - Запись остаётся в истории со статусом `refused`
   - Менеджер может выбрать другой банк
   - Создаётся новая запись для нового банка

### Ограничения

- Только одна активная заявка одновременно
- Менеджер выбирает банк вручную
- История всех попыток хранится в БД

### Изменения в виджете

```
┌─────────────────────────────────────┐
│ Кредитная заявка                    │
├─────────────────────────────────────┤
│ История:                            │
│ • Microinvest — Отказ (12.01.2026)  │
│ • Easy Credit — Одобрено            │
├─────────────────────────────────────┤
│ Текущая: Easy Credit                │
│ ID: EC12345 | Статус: Одобрено      │
├─────────────────────────────────────┤
│ [Выбрать другой банк]               │
│ (если текущая отклонена/нет заявки) │
└─────────────────────────────────────┘
```

### Поля в CRM (без изменений)

- `credit_company` — текущий выбранный банк
- `loan_application_id` — ID текущей активной заявки

## Задачи

### Этап 1: Подготовка БД
- [ ] Добавить модель `CreditApplication` в Prisma schema
- [ ] Миграция базы данных
- [ ] Создать `applicationRepository.js`

### Этап 2: Рефакторинг сервиса
- [ ] Вынести логику Microinvest в отдельный клиент
- [ ] Создать абстрактный интерфейс для банковских клиентов
- [ ] Обновить `creditService.js` для работы с историей

### Этап 3: Новые банки
- [ ] Easy Credit — клиент + маппинг статусов
- [ ] Iute Credit — клиент + маппинг статусов
- [ ] Maib — клиент + маппинг статусов

### Этап 4: Обновление виджета
- [ ] Показывать историю заявок
- [ ] Выбор банка при отправке
- [ ] Кнопка "Отправить в другой банк"

### Этап 5: Лента заявок
- [ ] Обновить ленту для показа всех банков
- [ ] Фильтры по банку

## Ожидание

- Документация API для Easy Credit, Iute Credit, Maib
